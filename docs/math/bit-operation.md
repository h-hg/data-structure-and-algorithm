# 位运算

整理收集各种位运算的“奇巧淫技”。

## 基本操作介绍

基本的位操作符有与、或、异或、取反、左移、右移这6种，它们的运算规则如下所示：

|符号|描述|运算规则|
|:-:|:-:|:-:|
|&|与|两个位都为1时，结果才为1|
|\||或|两个位都为0时，结果才为0|
|^|异或|两个位相同为0，相异为1|
|~|取反|0变1，1变0|
|<<|左移|各二进位全部左移若干位，高位丢弃，低位补0|
|>>|右移|各二进位全部右移若干位，对无符号数，高位补0，有符号数，各编译器处理方法不一样，有的补符号位（算术右移），有的补0（逻辑右移）|

示例：
1. `&`

```
  0101
& 0011
--------
  0001
```

2. `|`

```
  0101
| 0011
--------
  0111
```

3. `^`

```
  0101
^ 0011
--------
  0110
```

4. `~`

```
~ 0101
--------
  1010
```

5. `>>`

```
0101 >> 1 = 0010
```

6. `<<`

```
0101 << 1 = 1010
```

## 运算法则

###  异或

1. a ^ a = 0
2. a ^ b = b ^ a
3. a ^ b ^ c = a ^ (b ^ c) = (a ^ b) ^ c
4. a ^ 0 = a

### 与

1. a & a = a
2. a & b = b & a
3. a & b & c = (a & b) & c  = a & (b & c)
4. 0 & a = 0
5. 1..1 & a = a

###  或

1. a | a = a
2. a | b = b | a
3. a | b | c = (a |b ) | c = a | (b | c)
4. 0 | a =  a
5. 1...1 & a = 1...1

###  综合运算

1. (a | b) & c = (a & c) | (b & c)
2. a | (a & b) = a

## C语言中的优先级

`~` > `>>`、`<<` > `&` > `&` > `^` > `|`

## 奇巧淫技

### 整数的乘除法

如果在不溢出的情况下，与$2^n$的乘除法可以用位运算表示。
1. 乘法：$a * 2^n = a << n$
2. 除法：$a \ 2^n = a >> n$

原理：参考二进制的表示

### 交换

```cpp
void swap(int &a, int &b) {
  a ^= b;
  b ^= a;
  a ^= b;
}
```

原理：
1. `a ^= b;`，即`a = a ^ b`
2. `b ^= a;`，即`b = b ^ (a ^ b) = b ^ (b ^ a) = (b ^ b) ^ a = a`
3. `a ^= b`，即`a = (a ^ b) ^ a = a ^ a ^ b = b`

注意：a，b的值不能一样

### 变换符号

```cpp
int reversal(int a) {
  return ~a + 1;
}
```

原理：补码

### 大小写转换

```cpp
('d' ^ ' ') == 'D'; //true
('D' ^ '_') == 'd'; //true
```

原理：ASCII

### 是否异号

```cpp
int x = -1, y = 8;
bool ans = (x ^ y) >> 31;
```

原理：补码

### 求绝对值

```cpp
int abs(int a) {
  int i = a >> 31;//判断符号
  return i == 0 ? a : (~a + 1);
}
```

原理：补码，最高位表示符号位

### 加一

```cpp
n = -~n;
```

原理：补码

### 减一

```cpp
n = ~-n;
```

原理：补码

### 获取指定位上的值

步骤：将所需的位上的值设置为1，其余设置为0，进行与操作。原理同判断奇偶数。

原理：
```
  XXXX
& 0001
-------
  000X
```

例子：
1. 获取低八位

```cpp
b = a & 0xff;
```

2. 判断奇偶数

```cpp
void f(int a) {
  if (a & 1)
    //odd
  else
    //even
}
```

3. 模$2^n$

$r = a \& (2^n-1)$

```cpp
r = a & ((2 << n) - 1);
```

### 设置指定位上的值

位置从1开始，例如32位整数一共有32个位，即从第1位到第32位。

#### 设置为1

将要设置的位置为1，其它为0，进行或运算，例如设置的位为第(i+1)位为1

```cpp
a |= 1 << i
```

设置为1，可以用来保留最后某些位，如保留最后i-1位

```cpp
a & ((1<<i)-1)
```

#### 设置为0

将要设置的位置为0，其它为1，进行与运算，例如设置的位为第(i+1)位为0

```cpp
a &= ~(1<<i)
```

设置为零，可以用来清除最后某些位，例如清除最后i-1位

```cpp
a & ~((1<<i)-1)
```

### 高低位交换

例子：给定一个 16 位的无符号整数（例如34520 = 0b 10000110 11011000），将其高 8 位与低 8 位进行交换

```cpp
unsigned short a = 34520;
a = (a >> 8) | (a << 8);
```

### 消去最低位的1

```cpp
x = x & (x-1)
```

例子：x = 1100， x - 1 = 1011，x & (x-1) = 1000

相似的，判断一个二进制数中1的个数

```cpp
cnt = 0;
while(x) {
  a = a & (a-1);
  ++cnt;
}
```

### 仅保留最低位一个1

```cpp
a = a & (-a);
```

### 得到最高位的1

```cpp
a = a |(a>>1);
a = a |(a>>2);
a = a |(a>>4);
a = a |(a>>8);
a = a |(a>>16);
```
### 异或加密

设原文为o，密码为s，密文为c，那么c = o ^ s，s = c ^ s。

原理：s = c ^ s =  (o ^ s ) ^ s = o ^ (s ^ s) = o ^ 0 = o

## 更多资料

1. [Bit Twiddling Hacks](https://link.zhihu.com/?target=http%3A//graphics.stanford.edu/~seander/bithacks.html%23IntegerLogIEEE64Float)
2. [Lecture 2: Bit Hacks](https://link.zhihu.com/?target=https%3A//ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-172-performance-engineering-of-software-systems-fall-2010/video-lectures/lecture-2-bit-hacks/)

